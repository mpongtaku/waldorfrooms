<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waldorf Rooms</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<!-- EmailJS init (YOUR public key) -->
<script>
  emailjs.init("MaMAidecODASo6-E2");
</script>

<style>
  body { font-family: 'Inter', sans-serif; margin:0; padding:0; background:#f9f9f9; color:#333; }
  h1,h2,h3,h4,h5,h6 { margin:0; font-weight:600; }
  a{text-decoration:none; color:inherit;}
  button{font-weight:bold; cursor:pointer;}

  header{
    background:#fff;
    border-bottom:1px solid #ddd;
    padding:12px 24px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    position:sticky;
    top:0;
    z-index:1000;
  }
  header .logo{font-size:1.5rem; font-weight:700; color:#ff6b6b;}
  nav a{margin-left:16px; font-weight:500; color:#333;}

  section {padding:40px 20px;}

  .hero{
    background:#ffe6e1;
    text-align:center;
    padding:60px 20px;
  }
  .hero h1{font-size:2.5rem;margin-bottom:16px;}
  .hero p{font-size:1.2rem;margin-bottom:24px;}
  .hero button{
    background:#ff6b6b;
    color:#fff;
    border:none;
    padding:12px 24px;
    margin:8px;
    border-radius:8px;
    font-size:1rem;
  }

  .why-section, .testimonials, #listings, #faq {max-width:1000px;margin:0 auto;}
  .why-cards{display:flex; flex-wrap:wrap; gap:16px; justify-content:center;}
  .why-card{background:#fff; border-radius:12px; padding:24px; flex:1 1 200px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center;}

  .testimonial-city-buttons{display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:16px;}
  .testimonial-city-buttons button{
    margin:4px;
    background:#ff6b6b;
    color:#fff;
    border:none;
    padding:8px 16px;
    border-radius:6px;
    cursor:pointer;
  }
  .testimonial-list{display:none;}
  .testimonial-list.active{display:block;}
  .testimonial-card{
    background:#fff;
    padding:16px;
    border-radius:8px;
    margin-bottom:12px;
    box-shadow:0 1px 4px rgba(0,0,0,0.1);
  }
  .testimonial-card strong{display:block;margin-bottom:4px;}

  form{
    background:#fff;
    padding:20px;
    border-radius:12px;
    margin-bottom:40px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
    max-width:500px;
    margin-left:auto;
    margin-right:auto;
  }
  form input, form select, form textarea{
    width:100%;
    padding:10px;
    margin-bottom:12px;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:1rem;
  }
  form button{
    background:#ff6b6b;
    color:#fff;
    border:none;
    padding:12px;
    border-radius:8px;
    font-size:1rem;
    width:100%;
  }

  .listing-card{
    background:#fff;
    padding:16px;
    border-radius:12px;
    margin-bottom:16px;
    box-shadow:0 1px 4px rgba(0,0,0,0.1);
  }
  .listing-card img{max-width:100%; border-radius:8px; margin-bottom:8px;}
  .carousel img{width:100%; display:block;}

  .listings-controls{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:16px;
    font-size:0.95rem;
  }
  .listings-controls .filters{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .listings-controls select{
    padding:6px 10px;
    border-radius:6px;
    border:1px solid #ccc;
    font-size:0.95rem;
    background:#fff;
  }
  .listings-info{font-size:0.9rem; color:#555;}

  .faq{max-width:800px; margin:0 auto 60px auto;}
  .faq-item{
    background:#fff;
    padding:16px;
    margin-bottom:8px;
    border-radius:8px;
    cursor:pointer;
  }
  .faq-item p{display:none;margin-top:8px;}

  footer{
    background:#333;
    color:#fff;
    text-align:center;
    padding:24px 20px;
  }

  .whatsapp-btn{
    position:fixed;
    bottom:24px;
    right:24px;
    background:#25D366;
    color:#fff;
    border-radius:50%;
    width:60px;
    height:60px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:32px;
    z-index:1000;
    text-decoration:none;
  }

  #landlordAuthBox {
    max-width:500px;
    margin:0 auto 24px auto;
    padding:20px;
    background:#fff;
    border-radius:12px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
  }
  #landlordAuthBox h3{text-align:center;margin-bottom:8px;}
  #loginMessage{text-align:center;margin-top:8px;font-size:0.9rem;}
  #loggedInAs{text-align:center;margin-bottom:8px;font-size:0.95rem;}
  #logoutBtn{
    display:none;
    background:#444;
    color:#fff;
    border:none;
    padding:8px 16px;
    border-radius:6px;
    font-size:0.9rem;
    margin:0 auto 16px auto;
    max-width:150px;
  }
</style>
</head>
<body>
<header>
  <div class="logo">Waldorf Rooms</div>
  <nav>
    <a href="#home">Home</a>
    <a href="#tenants">Tenants</a>
    <a href="#landlords">Landlords</a>
    <a href="#listings">Available Listings</a>
    <a href="#testimonials">Testimonials</a>
    <a href="#faq">FAQs</a>
  </nav>
</header>

<section id="home" class="hero">
  <h1>Trusted, Local Connections for Rooms & Small Rentals</h1>
  <p>Serving Waldorf, La Plata, Bryans Road, and Accokeek â€“ without the stress of big listing sites.</p>
  <button onclick="window.location='#landlords'">Publish Your Room</button>
  <button onclick="window.location='#tenants'">Find a Room</button>
</section>

<!-- LANDLORD PORTAL -->
<section id="landlords">
  <h2 style="text-align:center; margin-bottom:24px;">Landlord Portal</h2>
  <div id="landlordAuthBox">
    <h3>Landlord â€“ Sign Up / Login</h3>
    <p style="text-align:center; font-size:0.9rem;">Create an account or log in to publish your room listing.</p>
    <form id="loginForm">
      <input type="email" name="email" placeholder="Email" required autocomplete="email" />
      <input type="password" name="password" placeholder="Password" required autocomplete="current-password" />
      <button type="submit">Sign Up / Login</button>
    </form>
    <p id="loginMessage"></p>
  </div>

  <p id="loggedInAs" style="display:none;"></p>
  <button id="logoutBtn">Logout</button>

  <form id="landlordForm" onsubmit="return uploadListing(this);" style="display:none;">
    <input type="text" name="landlord_name" placeholder="Your Name" required autocomplete="name" />
    <input type="email" name="landlord_email" placeholder="Email" required autocomplete="email" />
    <input type="tel" name="landlord_phone" placeholder="Phone" required autocomplete="tel" />
    <input type="text" name="room_title" placeholder="Room Title / Type" required autocomplete="off" />
    <input type="number" name="price" placeholder="Monthly Price" required autocomplete="off" />
    <select name="city" required autocomplete="address-level2">
      <option value="">Select City</option>
      <option value="Waldorf">Waldorf</option>
      <option value="La Plata">La Plata</option>
      <option value="Bryans Road">Bryans Road</option>
      <option value="Accokeek">Accokeek</option>
    </select>
    <textarea name="details" placeholder="Details about the room..." rows="3" required autocomplete="off"></textarea>
    <input type="file" name="room_image" accept="image/*" multiple required />
    <button type="submit">Publish Listing</button>
  </form>
</section>

<!-- TENANT FORM -->
<section id="tenants">
  <h2 style="text-align:center; margin-bottom:24px;">Tenant Request Form</h2>
  <form onsubmit="sendTenantForm(event)">
    <input type="text" name="tenant_name" placeholder="Your Name" required autocomplete="name" />
    <input type="email" name="tenant_email" placeholder="Email" required autocomplete="email" />
    <input type="tel" name="tenant_phone" placeholder="Phone" required autocomplete="tel" />
    <select name="desired_city" required autocomplete="address-level2">
      <option value="">Select City</option>
      <option value="Waldorf">Waldorf</option>
      <option value="La Plata">La Plata</option>
      <option value="Bryans Road">Bryans Road</option>
      <option value="Accokeek">Accokeek</option>
    </select>
    <textarea name="requirements" placeholder="Requirements / Notes" rows="3" required autocomplete="off"></textarea>
    <button type="submit">Send Request</button>
  </form>
</section>

<!-- AVAILABLE LISTINGS -->
<section id="listings">
  <h2 style="text-align:center; margin-bottom:16px;">Available Listings</h2>
  <div class="listings-controls">
    <div class="filters">
      <label>Filter by City:
        <select id="filterCity">
          <option value="all">All</option>
          <option value="Waldorf">Waldorf</option>
          <option value="La Plata">La Plata</option>
          <option value="Bryans Road">Bryans Road</option>
          <option value="Accokeek">Accokeek</option>
        </select>
      </label>
      <label>Sort by:
        <select id="sortListings">
          <option value="newest">Newest</option>
          <option value="price_low_high">Price Low â†’ High</option>
          <option value="price_high_low">Price High â†’ Low</option>
        </select>
      </label>
    </div>
    <div class="listings-info" id="listingsCount">0 listings</div>
  </div>
  <div id="availableListings"></div>
</section>

<!-- TESTIMONIALS -->
<section id="testimonials">
  <h2 style="text-align:center; margin-bottom:16px;">Testimonials</h2>
  <div class="testimonial-city-buttons">
    <button onclick="showTestimonials('Waldorf')">Waldorf</button>
    <button onclick="showTestimonials('LaPlata')">La Plata</button>
    <button onclick="showTestimonials('BryansRoad')">Bryans Road</button>
    <button onclick="showTestimonials('Accokeek')">Accokeek</button>
  </div>

  <div id="Waldorf" class="testimonial-list active">
    <div class="testimonial-card"><strong>John D.</strong> Great experience finding a room!</div>
    <div class="testimonial-card"><strong>Sarah K.</strong> Smooth process from viewing to moving in.</div>
    <div class="testimonial-card"><strong>Mike L.</strong> I liked the local focus on Waldorf only.</div>
  </div>

  <div id="LaPlata" class="testimonial-list">
    <div class="testimonial-card"><strong>Mary S.</strong> Landlords were responsive and fair.</div>
    <div class="testimonial-card"><strong>Robert P.</strong> Listings matched exactly what was advertised.</div>
  </div>

  <div id="BryansRoad" class="testimonial-list">
    <div class="testimonial-card"><strong>Linda T.</strong> Found a quiet room close to my work.</div>
    <div class="testimonial-card"><strong>Tom H.</strong> Landlords were very accommodating.</div>
  </div>

  <div id="Accokeek" class="testimonial-list">
    <div class="testimonial-card"><strong>Alice W.</strong> Easy to connect with landlords.</div>
    <div class="testimonial-card"><strong>Bob C.</strong> Listing info was accurate and clear.</div>
  </div>
</section>

<!-- FAQ -->
<section id="faq">
  <h2 style="text-align:center; margin-bottom:16px;">FAQs</h2>
  <div class="faq-item" onclick="toggleFaq(this)"><strong>How do I publish a room?</strong><p>Sign up as a landlord, log in, and complete the form under "Landlord Portal".</p></div>
  <div class="faq-item" onclick="toggleFaq(this)"><strong>Do I pay to list my room?</strong><p>Currently, listings are free while we build our local network.</p></div>
  <div class="faq-item" onclick="toggleFaq(this)"><strong>How long does it take to find a tenant?</strong><p>Most rooms get interest within 1â€“2 weeks.</p></div>
  <div class="faq-item" onclick="toggleFaq(this)"><strong>What cities do you serve?</strong><p>We focus on Waldorf, La Plata, Bryans Road, and Accokeek.</p></div>
  <div class="faq-item" onclick="toggleFaq(this)"><strong>Is my information secure?</strong><p>We only collect what is needed to connect tenants and landlords.</p></div>
</section>

<footer>&copy; 2025 Waldorf Rooms. All rights reserved.</footer>

<!-- WhatsApp floating button -->
<a href="https://wa.me/12402309731" target="_blank" class="whatsapp-btn">ðŸ’¬</a>

<script>
// ---------- CONFIG ----------
const supabaseUrl = "https://zufpufhjpjevyfmhhpck.supabase.co";
const supabaseKey = "sb_publishable_X4Bu7r08t8q4IkGE5q0Cew_D8tRKTNK";
const sb = supabase.createClient(supabaseUrl, supabaseKey);

let currentUser = null;
let allListings = [];

// ---------- UTILITY ----------
function showSupabaseError(context, error){
  console.error("Supabase error in:", context, error);
  let message = context + " failed.";
  if(error && error.message) message += "\nMessage: " + error.message;
  if(error && error.details) message += "\nDetails: " + error.details;
  alert(message);
}

// ---------- AUTH UI ----------
function setLoggedInUI(user){
  currentUser = user;
  document.getElementById('landlordAuthBox').style.display = "none";
  document.getElementById('landlordForm').style.display = "block";
  const loggedIn = document.getElementById('loggedInAs');
  loggedIn.style.display = "block";
  loggedIn.textContent = "Logged in as: " + user.email;
  document.getElementById('logoutBtn').style.display = "block";
}

function setLoggedOutUI(){
  currentUser = null;
  document.getElementById('landlordAuthBox').style.display = "block";
  document.getElementById('landlordForm').style.display = "none";
  document.getElementById('loggedInAs').style.display = "none";
  document.getElementById('logoutBtn').style.display = "none";
}

async function checkSession(){
  const { data, error } = await sb.auth.getSession();
  if(error){
    showSupabaseError("Get session", error);
    setLoggedOutUI();
    return;
  }
  const session = data?.session;
  if(session?.user){ setLoggedInUI(session.user); }
  else{ setLoggedOutUI(); }
}

// ---------- LOAD LISTINGS ----------
async function loadListings(){
  try{
    const { data: listings, error } = await sb
      .from("listings")
      .select("*")
      .order("id",{ascending:false});
    if(error){
      showSupabaseError("Loading listings", error);
      return;
    }
    allListings = listings || [];
    renderListings();
  } catch(e){
    alert("Unexpected loadListings error");
    console.error(e);
  }
}

function renderListings(){
  const container = document.getElementById("availableListings");
  const countSpan  = document.getElementById("listingsCount");
  const filterCity = document.getElementById("filterCity").value;
  const sortBy = document.getElementById("sortListings").value;

  let filtered = allListings.slice();
  if(filterCity !== "all"){
    filtered = filtered.filter(l => (l.city || "").toLowerCase() === filterCity.toLowerCase());
  }

  filtered.sort((a,b)=>{
    if(sortBy==="price_low_high") return a.price - b.price;
    if(sortBy==="price_high_low") return b.price - a.price;
    return b.id - a.id; // newest
  });

  container.innerHTML="";
  countSpan.textContent = filtered.length + " listing" + (filtered.length===1?"":"s");
  if(filtered.length===0){
    container.innerHTML="<p>No listings found.</p>";
    return;
  }

  filtered.forEach((l, idx)=>{
    const div=document.createElement("div");
    div.className="listing-card";
    div.dataset.currentSlide=0;
    const images = Array.isArray(l.image_urls)?l.image_urls:[];
    let imagesHtml="";
    const domIdx="f"+idx;
    if(images.length>0){
      imagesHtml += `<div class="carousel" id="carousel-${domIdx}" style="position:relative; overflow:hidden; border-radius:8px;">`;
      images.forEach((url,i)=>{
        imagesHtml+=`<img src="${url}" style="display:${i===0?'block':'none'};">`;
      });
      if(images.length>1){
        imagesHtml += `
          <button onclick="prevSlide('${domIdx}')" style="position:absolute;top:50%;left:0;transform:translateY(-50%);background:rgba(0,0,0,0.3);color:#fff;border:none;padding:8px;cursor:pointer;">â€¹</button>
          <button onclick="nextSlide('${domIdx}')" style="position:absolute;top:50%;right:0;transform:translateY(-50%);background:rgba(0,0,0,0.3);color:#fff;border:none;padding:8px;cursor:pointer;">â€º</button>`;
      }
      imagesHtml+="</div>";
    }
    div.innerHTML = `
      ${imagesHtml}
      <h3>${l.room_title || ""}</h3>
      <p>${l.details || ""}</p>
      <p><strong>Price:</strong> $${l.price} / month</p>
      <p><strong>City:</strong> ${l.city || ""}</p>`;
    container.appendChild(div);
  });
}

function nextSlide(id){
  const carousel = document.getElementById(`carousel-${id}`);
  if(!carousel) return;
  const imgs = carousel.querySelectorAll("img");
  if(!imgs.length) return;
  let current = parseInt(carousel.dataset.currentSlide || 0);
  imgs[current].style.display="none";
  current = (current+1)%imgs.length;
  imgs[current].style.display="block";
  carousel.dataset.currentSlide=current;
}

function prevSlide(id){
  const carousel = document.getElementById(`carousel-${id}`);
  if(!carousel) return;
  const imgs = carousel.querySelectorAll("img");
  if(!imgs.length) return;
  let current = parseInt(carousel.dataset.currentSlide || 0);
  imgs[current].style.display="none";
  current = (current-1+imgs.length)%imgs.length;
  imgs[current].style.display="block";
  carousel.dataset.currentSlide=current;
}

// ---------- LANDLORD LOGIN / LOGOUT ----------
document.getElementById("loginForm").addEventListener("submit", async function(e){
  e.preventDefault();
  const email = this.email.value.trim();
  const password = this.password.value.trim();
  try{
    const { data, error } = await sb.auth.signUp({ email, password });
    if(error && error.message && error.message.includes("User already registered")){
      const { data: loginData, error: loginError } =
        await sb.auth.signInWithPassword({ email, password });
      if(loginError){
        showSupabaseError("Login", loginError);
        return;
      }
      setLoggedInUI(loginData.user);
    } else if(error){
      showSupabaseError("SignUp", error);
      return;
    } else {
      setLoggedInUI(data.user);
    }
  } catch(err){
    alert("Unexpected login/signup error");
    console.error(err);
  }
});

document.getElementById("logoutBtn").addEventListener("click", async function(){
  await sb.auth.signOut();
  setLoggedOutUI();
});

// ---------- LANDLORD LISTING UPLOAD ----------
async function uploadListing(form){
  if(!currentUser){
    alert("Please log in first.");
    return false;
  }

  const room_title = form.room_title.value.trim();
  const details = form.details.value.trim();
  const price = parseFloat(form.price.value);
  const city = form.city.value;
  const files = form.room_image.files;
  if(!files.length){
    alert("Please select at least one image.");
    return false;
  }

  try{
    const image_urls=[];
    for(let f of files){
      const filename = Date.now() + "_" + f.name;
      const { data: uploadData, error: uploadError } =
        await sb.storage.from("rooms").upload(filename, f);
      if(uploadError){
        showSupabaseError("Image upload", uploadError);
        return false;
      }
      const { data: publicData } = sb.storage.from("rooms").getPublicUrl(filename);
      image_urls.push(publicData.publicUrl);
    }

    const { data, error } = await sb.from("listings").insert([{
      landlord_name: form.landlord_name.value.trim(),
      landlord_email: form.landlord_email.value.trim(),
      landlord_phone: form.landlord_phone.value.trim(),
      room_title,
      details,
      price,
      city,
      image_urls
    }]);

    if(error){
      showSupabaseError("Insert listing", error);
      return false;
    }
    alert("Listing uploaded successfully!");
    form.reset();
    loadListings();
  } catch(e){
    alert("Unexpected upload error");
    console.error(e);
  }
  return false;
}

// ---------- TENANT FORM (EmailJS) ----------
function sendTenantForm(e){
  e.preventDefault();
  const form = e.target;
  const templateParams = {
    from_name: form.tenant_name.value,
    email: form.tenant_email.value,
    phone: form.tenant_phone.value,
    city: form.desired_city.value,
    message: form.requirements.value
  };

  // Use your real EmailJS Service + Template IDs
  emailjs
    .send("service_ybsskt9", "template_w921zcz", templateParams)
    .then(() => {
      alert("Request sent successfully!");
      form.reset();
    })
    .catch(err => {
      alert("Error sending request.");
      console.error(err);
    });
}

// ---------- FAQ ----------
function toggleFaq(elem){
  const p = elem.querySelector("p");
  if(!p) return;
  p.style.display = (p.style.display==="block" ? "none" : "block");
}

// ---------- TESTIMONIALS ----------
function showTestimonials(city){
  document.querySelectorAll(".testimonial-list").forEach(l => l.classList.remove("active"));
  const el = document.getElementById(city);
  if(el){ el.classList.add("active"); }
}

// ---------- INIT ----------
checkSession();
loadListings();
document.getElementById("filterCity").addEventListener("change", renderListings);
document.getElementById("sortListings").addEventListener("change", renderListings);
</script>
</body>
</html>
