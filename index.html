<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waldorf Rooms</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<!-- EmailJS init -->
<script>
  emailjs.init("MaMAidecODASo6-E2");
</script>

<style>
  body { font-family: 'Inter', sans-serif; margin:0; padding:0; background:#f9f9f9; color:#333; }
  h1,h2,h3,h4,h5,h6 { margin:0; font-weight:600; }
  a{text-decoration:none; color:inherit;}
  button{font-weight:bold; cursor:pointer;}

  header{
    background:#fff;
    border-bottom:1px solid #ddd;
    padding:12px 24px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    position:sticky;
    top:0;
    z-index:1000;
  }
  header .logo{font-size:1.5rem; font-weight:700; color:#ff6b6b;}
  nav a{margin-left:16px; font-weight:500; color:#333;}

  section {padding:40px 20px;}

  .hero{
    background:#ffe6e1;
    text-align:center;
    padding:60px 20px;
  }
  .hero h1{font-size:2.5rem;margin-bottom:16px;}
  .hero p{font-size:1.2rem;margin-bottom:24px;}
  .hero button{
    background:#ff6b6b;
    color:#fff;
    border:none;
    padding:12px 24px;
    margin:8px;
    border-radius:8px;
    font-size:1rem;
  }

  .why-section, .testimonials, #listings, #faq {max-width:1000px;margin:0 auto;}
  .testimonial-city-buttons{display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:16px;}
  .testimonial-city-buttons button{
    margin:4px;
    background:#ff6b6b;
    color:#fff;
    border:none;
    padding:8px 16px;
    border-radius:6px;
    cursor:pointer;
  }
  .testimonial-list{display:none;}
  .testimonial-list.active{display:block;}
  .testimonial-card{
    background:#fff;
    padding:16px;
    border-radius:8px;
    margin-bottom:12px;
    box-shadow:0 1px 4px rgba(0,0,0,0.1);
  }
  .testimonial-card strong{display:block;margin-bottom:4px;}

  form{
    background:#fff;
    padding:20px;
    border-radius:12px;
    margin-bottom:40px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
    max-width:500px;
    margin-left:auto;
    margin-right:auto;
  }
  form input, form select, form textarea{
    width:100%;
    padding:10px;
    margin-bottom:12px;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:1rem;
  }
  form button{
    background:#ff6b6b;
    color:#fff;
    border:none;
    padding:12px;
    border-radius:8px;
    font-size:1rem;
    width:100%;
  }

  .listing-card{
    background:#fff;
    padding:16px;
    border-radius:12px;
    margin-bottom:16px;
    box-shadow:0 1px 4px rgba(0,0,0,0.1);
  }
  .listing-card img{max-width:100%; border-radius:8px; margin-bottom:8px;}
  .carousel img{width:100%; display:block;}

  .listings-controls{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:16px;
    font-size:0.95rem;
  }
  .listings-controls .filters{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .listings-controls select{
    padding:6px 10px;
    border-radius:6px;
    border:1px solid #ccc;
    font-size:0.95rem;
    background:#fff;
  }
  .listings-info{font-size:0.9rem; color:#555;}

  .faq{max-width:800px; margin:0 auto 60px auto;}
  .faq-item{
    background:#fff;
    padding:16px;
    margin-bottom:8px;
    border-radius:8px;
    cursor:pointer;
  }
  .faq-item p{display:none;margin-top:8px;}

  footer{
    background:#333;
    color:#fff;
    text-align:center;
    padding:24px 20px;
  }

  .whatsapp-btn{
    position:fixed;
    bottom:24px;
    right:24px;
    background:#25D366;
    color:#fff;
    border-radius:50%;
    width:60px;
    height:60px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:32px;
    z-index:1000;
    text-decoration:none;
  }

  #toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: #fff;
    padding: 12px 24px;
    border-radius: 8px;
    display: none;
    z-index: 2000;
    font-size: 0.95rem;
  }
</style>
</head>
<body>
<header>
  <div class="logo">Waldorf Rooms</div>
  <nav>
    <a href="#home">Home</a>
    <a href="#tenants">Tenants</a>
    <a href="#landlords">Landlords</a>
    <a href="#listings">Available Listings</a>
    <a href="#testimonials">Testimonials</a>
    <a href="#faq">FAQs</a>
  </nav>
</header>

<section id="home" class="hero">
  <h1>Trusted, Local Connections for Rooms & Small Rentals</h1>
  <p>Serving Waldorf, La Plata, Bryans Road, and Accokeek â€“ without the stress of big listing sites.</p>
  <button onclick="window.location='#landlords'">Publish Your Room</button>
  <button onclick="window.location='#tenants'">Find a Room</button>
</section>

<!-- LANDLORD PORTAL -->
<section id="landlords">
  <h2 style="text-align:center; margin-bottom:24px;">Landlord Portal</h2>
  <div id="landlordAuthBox">
    <h3>Landlord â€“ Sign Up / Login</h3>
    <p style="text-align:center; font-size:0.9rem;">Create an account or log in to publish your room listing.</p>
    <form id="loginForm">
      <input type="email" name="email" placeholder="Email" required autocomplete="email" />
      <input type="password" name="password" placeholder="Password" required autocomplete="current-password" />
      <button type="submit">Sign Up / Login</button>
    </form>
    <p id="loginMessage"></p>
  </div>

  <p id="loggedInAs" style="display:none;"></p>
  <button id="logoutBtn">Logout</button>

  <form id="landlordForm" onsubmit="return uploadListing(this);" style="display:none;">
    <input type="text" name="landlord_name" placeholder="Your Name" required autocomplete="name" />
    <input type="email" name="landlord_email" placeholder="Email" required autocomplete="email" />
    <input type="tel" name="landlord_phone" placeholder="Phone" required autocomplete="tel" />
    <input type="text" name="room_title" placeholder="Room Title / Type" required autocomplete="off" />
    <input type="number" name="price" placeholder="Monthly Price" required autocomplete="off" />
    <select name="city" required autocomplete="address-level2">
      <option value="">Select City</option>
      <option value="Waldorf">Waldorf</option>
      <option value="La Plata">La Plata</option>
      <option value="Bryans Road">Bryans Road</option>
      <option value="Accokeek">Accokeek</option>
    </select>
    <textarea name="details" placeholder="Details about the room..." rows="3" required autocomplete="off"></textarea>
    <input type="file" name="room_image" accept="image/*" multiple required />
    <button type="submit">Publish Listing</button>
  </form>
</section>

<!-- TENANT FORM -->
<section id="tenants">
  <h2 style="text-align:center; margin-bottom:24px;">Tenant Request Form</h2>
  <form id="tenantForm">
    <input type="text" name="tenant_name" placeholder="Your Name" required autocomplete="name" />
    <input type="email" name="tenant_email" placeholder="Email" required autocomplete="email" />
    <input type="tel" name="tenant_phone" placeholder="Phone" required autocomplete="tel" />
    <select name="desired_city" required autocomplete="address-level2">
      <option value="">Select City</option>
      <option value="Waldorf">Waldorf</option>
      <option value="La Plata">La Plata</option>
      <option value="Bryans Road">Bryans Road</option>
      <option value="Accokeek">Accokeek</option>
    </select>
    <textarea name="requirements" placeholder="Requirements / Notes" rows="3" required autocomplete="off"></textarea>
    <button type="submit">Send Request</button>
  </form>
</section>

<!-- AVAILABLE LISTINGS -->
<section id="listings">
  <h2 style="text-align:center; margin-bottom:16px;">Available Listings</h2>
  <div class="listings-controls">
    <div class="filters">
      <label>Filter by City:
        <select id="filterCity">
          <option value="all">All</option>
          <option value="Waldorf">Waldorf</option>
          <option value="La Plata">La Plata</option>
          <option value="Bryans Road">Bryans Road</option>
          <option value="Accokeek">Accokeek</option>
        </select>
      </label>
      <label>Sort by:
        <select id="sortListings">
          <option value="newest">Newest</option>
          <option value="price_low_high">Price Low â†’ High</option>
          <option value="price_high_low">Price High â†’ Low</option>
        </select>
      </label>
    </div>
    <div class="listings-info" id="listingsCount">0 listings</div>
  </div>
  <div id="availableListings"></div>
</section>

<!-- TESTIMONIALS -->
<section id="testimonials">
  <h2 style="text-align:center; margin-bottom:16px;">Testimonials</h2>
  <div class="testimonial-city-buttons">
    <button onclick="showTestimonials('Waldorf')">Waldorf</button>
    <button onclick="showTestimonials('LaPlata')">La Plata</button>
    <button onclick="showTestimonials('BryansRoad')">Bryans Road</button>
    <button onclick="showTestimonials('Accokeek')">Accokeek</button>
  </div>
  <div id="testimonialContainer"></div>
</section>

<!-- FAQ -->
<section id="faq">
  <h2 style="text-align:center; margin-bottom:16px;">FAQs</h2>
  <div id="faqContainer"></div>
</section>

<footer>&copy; 2025 Waldorf Rooms. All rights reserved.</footer>

<!-- WhatsApp floating button -->
<a href="https://wa.me/12402309731" target="_blank" class="whatsapp-btn">ðŸ’¬</a>

<!-- Toast Notification -->
<div id="toast"></div>

<script>
// ---------- CONFIG ----------
const supabaseUrl = "https://zufpufhjpjevyfmhhpck.supabase.co";
const supabaseKey = "sb_publishable_X4Bu7r08t8q4IkGE5q0Cew_D8tRKTNK";
const sb = supabase.createClient(supabaseUrl, supabaseKey);

let currentUser = null;
let allListings = [];
let allTestimonials = [];
let allFaqs = [];

// ---------- Toast ----------
function showToast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=>{t.style.display="none";}, 3000);
}

// ---------- AUTH ----------
function setLoggedInUI(user){
  currentUser = user;
  document.getElementById('landlordAuthBox').style.display = "none";
  document.getElementById('landlordForm').style.display = "block";
  const loggedIn = document.getElementById('loggedInAs');
  loggedIn.style.display = "block";
  loggedIn.textContent = "Logged in as: " + user.email;
  document.getElementById('logoutBtn').style.display = "block";
}

function setLoggedOutUI(){
  currentUser = null;
  document.getElementById('landlordAuthBox').style.display = "block";
  document.getElementById('landlordForm').style.display = "none";
  document.getElementById('loggedInAs').style.display = "none";
  document.getElementById('logoutBtn').style.display = "none";
}

async function checkSession(){
  const { data, error } = await sb.auth.getSession();
  if(error){ setLoggedOutUI(); return; }
  const session = data?.session;
  if(session?.user){ setLoggedInUI(session.user); }
  else{ setLoggedOutUI(); }
}

// ---------- LISTINGS ----------
async function loadListings(){
  try{
    const { data: listings, error } = await sb.from("listings").select("*").order("id",{ascending:false});
    if(error){ showToast("Error loading listings."); return; }
    allListings = listings || [];
    renderListings();
  } catch(e){ showToast("Unexpected loadListings error."); console.error(e); }
}

function renderListings(){
  const container = document.getElementById("availableListings");
  const countSpan  = document.getElementById("listingsCount");
  const filterCity = document.getElementById("filterCity").value;
  const sortBy = document.getElementById("sortListings").value;

  let filtered = allListings.slice();
  if(filterCity !== "all"){
    filtered = filtered.filter(l => (l.city || "").toLowerCase() === filterCity.toLowerCase());
  }

  filtered.sort((a,b)=>{
    if(sortBy==="price_low_high") return a.price - b.price;
    if(sortBy==="price_high_low") return b.price - a.price;
    return b.id - a.id;
  });

  container.innerHTML="";
  countSpan.textContent = filtered.length + " listing" + (filtered.length===1?"":"s");
  if(filtered.length===0){ container.innerHTML="<p>No listings found.</p>"; return; }

  filtered.forEach((l, idx)=>{
    const div=document.createElement("div");
    div.className="listing-card";
    const images = Array.isArray(l.image_urls)?l.image_urls:[];
    let imagesHtml="";
    const domIdx="f"+idx;
    if(images.length>0){
      imagesHtml += `<div class="carousel" id="carousel-${domIdx}" style="position:relative; overflow:hidden; border-radius:8px;">`;
      images.forEach((url,i)=>{
        imagesHtml+=`<img src="${url}" style="display:${i===0?'block':'none'};">`;
      });
      if(images.length>1){
        imagesHtml += `<button onclick="prevSlide('${domIdx}')" style="position:absolute;top:50%;left:0;transform:translateY(-50%);background:rgba(0,0,0,0.3);color:#fff;border:none;padding:8px;cursor:pointer;">â€¹</button>
        <button onclick="nextSlide('${domIdx}')" style="position:absolute;top:50%;right:0;transform:translateY(-50%);background:rgba(0,0,0,0.3);color:#fff;border:none;padding:8px;cursor:pointer;">â€º</button>`;
      }
      imagesHtml+="</div>";
    }
    div.innerHTML = `${imagesHtml}<h3>${l.room_title || ""}</h3>
      <p>${l.details || ""}</p>
      <p><strong>Price:</strong> $${l.price} / month</p>
      <p><strong>City:</strong> ${l.city || ""}</p>`;
    container.appendChild(div);
  });
}

function nextSlide(id){
  const carousel = document.getElementById(`carousel-${id}`);
  if(!carousel) return;
  const imgs = carousel.querySelectorAll("img");
  if(!imgs.length) return;
  let current = parseInt(carousel.dataset.currentSlide || 0);
  imgs[current].style.display="none";
  current = (current+1)%imgs.length;
  imgs[current].style.display="block";
  carousel.dataset.currentSlide=current;
}

function prevSlide(id){
  const carousel = document.getElementById(`carousel-${id}`);
  if(!carousel) return;
  const imgs = carousel.querySelectorAll("img");
  if(!imgs.length) return;
  let current = parseInt(carousel.dataset.currentSlide || 0);
  imgs[current].style.display="none";
  current = (current-1+imgs.length)%imgs.length;
  imgs[current].style.display="block";
  carousel.dataset.currentSlide=current;
}

// ---------- LANDLORD FORM ----------
async function uploadListing(form){
  if(!currentUser){ showToast("Please log in first."); return false; }
  const formData = new FormData(form);
  const room_title = formData.get("room_title");
  const details = formData.get("details");
  const price = parseFloat(formData.get("price"));
  const city = formData.get("city");
  const landlord_name = formData.get("landlord_name");
  const landlord_email = formData.get("landlord_email");
  const landlord_phone = formData.get("landlord_phone");
  const images = formData.getAll("room_image");

  let imageUrls = [];
  for(const file of images){
    const { data, error } = await sb.storage.from("rooms").upload(`${Date.now()}_${file.name}`, file);
    if(error){ console.error(error); showToast("Error uploading image."); return false; }
    const url = sb.storage.from("rooms").getPublicUrl(data.path).publicUrl;
    imageUrls.push(url);
  }

  const { data, error } = await sb.from("listings").insert([{
    landlord_name, landlord_email, landlord_phone, room_title, details, price, city, image_urls:imageUrls
  }]);
  if(error){ console.error(error); showToast("Error saving listing."); return false; }

  showToast("Listing published!");
  form.reset();
  loadListings();
  return false;
}

// ---------- TENANT FORM ----------
document.getElementById("tenantForm").onsubmit = async function(e){
  e.preventDefault();
  const form = e.target;
  const name = form.tenant_name.value;
  const email = form.tenant_email.value;
  const phone = form.tenant_phone.value;
  const city = form.desired_city.value;
  const requirements = form.requirements.value;

  try{
    // Save to Supabase
    await sb.from("tenant_requests").insert([{name,email,phone,city,requirements}]);
    // EmailJS
    emailjs.send("service_id","template_id",{name,email,phone,city,requirements});
    showToast("Request sent successfully!");
    form.reset();
  }catch(e){ console.error(e); showToast("Error sending request."); }
};

// ---------- TESTIMONIALS ----------
allTestimonials = {
  Waldorf: [
    {name:"Emma R.", text:"Landlord responses were quick and helpful."},
    {name:"Jason M.", text:"The site made it easy to compare rooms locally."},
    {name:"Alice T.", text:"Found a room that fit my budget perfectly."},
    {name:"Mark D.", text:"Easy to navigate and post my room as landlord."}
  ],
  LaPlata:[
    {name:"Linda G.", text:"Very user-friendly experience."},
    {name:"Peter V.", text:"I found my room within a week!"},
    {name:"Sophie H.", text:"Great listings with clear details."},
    {name:"Tom F.", text:"Smooth communication with landlords."}
  ],
  BryansRoad:[
    {name:"Nancy B.", text:"Listings were accurate and easy to view."},
    {name:"Kevin L.", text:"The landlord portal is simple to use."},
    {name:"Derek C.", text:"Helpful support team for any questions."},
    {name:"Olivia S.", text:"Room photos were clear and updated."}
  ],
  Accokeek:[
    {name:"Rachel W.", text:"Great local community focus."},
    {name:"Samuel H.", text:"I appreciated the detailed room info."},
    {name:"Laura J.", text:"Found a nice, affordable room easily."},
    {name:"Henry B.", text:"The site is very intuitive."}
  ]
};

function showTestimonials(city){
  const container = document.getElementById("testimonialContainer");
  container.innerHTML="";
  const list = allTestimonials[city] || [];
  list.forEach(t=>{
    const div = document.createElement("div");
    div.className="testimonial-card";
    div.innerHTML=`<strong>${t.name}</strong><p>${t.text}</p>`;
    container.appendChild(div);
  });
}

// ---------- FAQ ----------
allFaqs=[
  {q:"Can I edit my listing after publishing?",a:"Yes, log in and update your listing through the Landlord Portal."},
  {q:"Are tenants screened?",a:"Currently, tenants submit requests; screening is done directly by landlords."},
  {q:"Can I delete my account?",a:"Yes, contact support to remove your account and listings."},
  {q:"How long are listings visible?",a:"Listings remain visible until the landlord removes them or marks them rented."},
  {q:"Is there a fee to post a listing?",a:"No, posting a room is free for landlords."},
  {q:"Can tenants contact multiple landlords?",a:"Yes, tenants can submit requests to multiple landlords."}
];

function renderFaqs(){
  const container = document.getElementById("faqContainer");
  container.innerHTML="";
  allFaqs.forEach((f,idx)=>{
    const div=document.createElement("div");
    div.className="faq-item";
    div.innerHTML=`<h4>${f.q}</h4><p>${f.a}</p>`;
    div.onclick = function(){
      const p = div.querySelector("p");
      p.style.display = p.style.display==="block"?"none":"block";
    }
    container.appendChild(div);
  });
}

// ---------- AUTH FORM ----------
document.getElementById("loginForm").onsubmit = async function(e){
  e.preventDefault();
  const email = this.email.value;
  const password = this.password.value;
  try{
    const { data, error } = await sb.auth.signInWithPassword({email,password});
    if(error){
      // Try signup if login fails
      const { data:signupData, error:signupErr } = await sb.auth.signUp({email,password});
      if(signupErr){ showToast("Auth failed: "+signupErr.message); return; }
      setLoggedInUI(signupData.user);
      showToast("Account created & logged in!");
      return;
    }
    setLoggedInUI(data.user);
    showToast("Logged in successfully!");
  }catch(err){ console.error(err); showToast("Login error."); }
};

document.getElementById("logoutBtn").onclick = async ()=>{
  await sb.auth.signOut();
  setLoggedOutUI();
  showToast("Logged out.");
};

// ---------- INIT ----------
document.addEventListener("DOMContentLoaded",()=>{
  checkSession();
  loadListings();
  renderFaqs();
});
</script>
</body>
</html>
